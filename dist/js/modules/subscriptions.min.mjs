import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";export default class Subscriptions{id;thread_author={};poster;thread_title={};timestamp={};forum={};post_timestamp={};post_author={};extra_info;constructor(){}static check_status(){let t=new Common;Chrome.get_storage({show_subscriptions:t.get_defaults("show_subscriptions")},(t=>{t.show_subscriptions?($(".alert-no-sections").addClass("hidden"),$(".subscriptions-tab-nav a").removeClass("hidden")):$("#subscriptions .alert-subscriptions-message").removeClass("hidden")}))}static get_threads(){let t=new Common,e=$("#subscriptions");e.find(".thread-item:gt(0)").remove(),e.find(".alert-subscriptions-message").addClass("hidden"),$.getJSON(t.get_page_url("watched/threads?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Subscriptions.set_response)}set_author(t){let e=new Common;t.link=t.link.replace("miembros","members"),t.link=e.get_page_url(t.link.substr(1)),1===$(t.avatar).find("img").length?(t.avatar=$(t.avatar).find("img").attr("src"),t.figure=!0):(t.avatar=$(t.avatar).find("span").html(),t.figure=!1),this.thread_author=t}set_id(t){this.id=parseInt(t)}set_is_poster(t){this.poster=t}set_title(t){let e=new Common;t.link=t.link.replace("temas","threads"),t.link=e.get_page_url(t.link.substr(1)),this.thread_title=t}set_timestamp(t){this.timestamp=t}set_forum(t){let e=new Common;t.link=t.link.replace("foros","forums"),t.link=e.get_page_url(t.link.substr(1)),this.forum=t}set_post_timestamp(t){this.post_timestamp=t}set_post_author(t){let e=new Common;t.link=t.link.replace("miembros","members"),t.link=e.get_page_url(t.link.substr(1)),1===$(t.avatar).find("img").length?(t.avatar=$(t.avatar).find("img").attr("src"),t.figure=!0):(t.avatar=$(t.avatar).find("span").html(),t.figure=!1),this.post_author=t}set_extra(t){this.extra_info=t}set_status(t){this.status=t}static set_response(t){let e=$.parseHTML(t.html.content),r=$("#subscriptions");r.find(".alert-processing").hide(),$(e).find(".structItem--thread").length>0?$(e).find(".structItem--thread").each(((t,e)=>{let r=new Subscriptions,a={id:$(e).find(".structItem-cell--icon:first a.avatar").data("user-id"),name:$(e).find(".structItem-cell--icon:first a.avatar img").attr("alt"),avatar:$(e).find(".structItem-cell--icon:first a.avatar"),link:$(e).find(".structItem-cell--icon:first a.avatar").attr("href")},s={title:$(e).find(".structItem-cell--main .structItem-title a").html(),link:$(e).find(".structItem-cell--main .structItem-title a").attr("href")},i={title:$(e).find(".structItem-cell--main .structItem-startDate time").attr("title"),text:$(e).find(".structItem-cell--main .structItem-startDate time").html()},o={name:$(e).find(".structItem-cell--main .structItem-parts li:last a").html(),link:$(e).find(".structItem-cell--main .structItem-parts li:last a").attr("href")},n={title:$(e).find(".structItem-cell--latest .structItem-latestDate").attr("title"),text:$(e).find(".structItem-cell--latest .structItem-latestDate").html()},m={id:$(e).find(".structItem-cell--iconEnd a.avatar").data("user-id"),name:$(e).find(".structItem-cell--iconEnd a.avatar img").attr("alt"),avatar:$(e).find(".structItem-cell--iconEnd a.avatar"),link:$(e).find(".structItem-cell--iconEnd a.avatar").attr("href")};r.set_id($(e).find(".structItem-cell--main .structItem-extraInfo input").val()),r.set_author(a),r.set_is_poster($(e).find(".structItem-cell--icon:first .structItem-secondaryIcon").length>0),r.set_title(s),r.set_timestamp(i),r.set_forum(o),r.set_post_timestamp(n),r.set_post_author(m),r.set_extra($(e).find(".structItem-cell--main .structItem-extraInfo li").length>1),r.set_status($(e).hasClass("is-unread")),Common.is_background()?r.notify():r.display()})):r.find(".alert-subscriptions-message").removeClass("hidden")}display(){let t=$("#subscriptions .thread-item:first").clone(),e=this.thread_author,r=this.thread_title,a=this.timestamp,s=this.forum,i=this.post_author,o=this.post_timestamp;$(t).find(".thread-avatar").attr("title",e.name).attr("href",e.link),e.figure?$(t).find(".thread-avatar > img").attr("src",e.avatar).attr("alt",e.name):$(t).find(".thread-avatar > img").addClass("bg-gray-600 border border-gray-900"),this.status&&($(t).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(t).find(".thread-title").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(t).find(".thread-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(t).find(".thread-info").addClass("divide-yellow-400 dark:divide-yellow-500"),$(t).find(".thread-footer").addClass("text-gray-600 dark:text-gray-500"),$(t).find(".thread-actions a").removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")),this.poster&&$(t).find(".thread-poster").addClass("border-blue-500 dark:border-blue-600"),this.extra_info&&$(t).find(".subscription-email").addClass("border-green-500 hover:border-green-600 dark:border-green-600 dark:hover:border-green-500 text-green-500 dark:text-green-600 dark:hover:text-green-500"),this.set_actions(t),$(t).find(".thread-title").html(r.title).attr("href",r.link),$(t).find(".thread-starter").attr("title",e.name).attr("href",e.link).html(e.name),$(t).find(".thread-time").attr("title",a.title).attr("href",r.link).html(a.text),$(t).find(".thread-forum").attr("title",s.name).attr("href",s.link).html(s.name),$(t).find(".message-by").attr("title",i.name).attr("href",i.link).html(i.name),$(t).find(".message-at").attr("title",o.title).attr("href",r.link+"latest").html(o.text),$(t).find(".subscription-delete").attr("href",r.link+"watch"),$(t).removeClass("hidden").appendTo("#subscriptions .thread-container")}set_actions(t){let e=new Common,r=this;$(t).find(".subscription-email").on("click",(t=>{let a=t.currentTarget,s={"thread_ids[]":r.id,state:r.extra_info?"watch_no_email":"watch_email",_xfToken:Common.get_token(),_xfResponseType:"json"};return t.preventDefault(),$(a).addClass("animate-pulse"),$.post(e.get_page_url("watched/threads/update"),s,(t=>{$(a).removeClass("animate-pulse"),"ok"===t.status&&(r.extra_info?(r.set_extra(!1),$(a).removeClass("border-green-500 hover:border-green-600 dark:border-green-600 dark:hover:border-green-500 text-green-500 dark:text-green-600 dark:hover:text-green-500")):(r.set_extra(!0),$(a).addClass("border-green-500 hover:border-green-600 dark:border-green-600 dark:hover:border-green-500 text-green-500 dark:text-green-600 dark:hover:text-green-500")))})),!1})),$(t).find(".subscription-delete").on("click",(a=>{let s=a.currentTarget,i={"thread_ids[]":r.id,state:"delete",_xfToken:Common.get_token(),_xfResponseType:"json"};return a.preventDefault(),$(s).addClass("animate-pulse"),$.post(e.get_page_url("watched/threads/update"),i,(e=>{$(s).removeClass("animate-pulse"),"ok"===e.status&&$(t).slideUp()})),!1}))}notify(){let t,e=new Common,r=this.post_author,a=this,s=Chrome.get_message("extension_short_name")+".Subscriptions."+a.id;t=r.figure?r.avatar:"../dist/img/icon.png",Chrome.get_storage({subscriptions_notification:e.get_defaults("subscriptions_notification")},(e=>{if(e.subscriptions_notification&&a.status&&!Common.is_notified(s)){let e=[];Common.set_notifications(s),e[s]={notification_url:a.thread_title.link},Chrome.send_notification(s,{type:"basic",title:Chrome.get_message("extension_short_name")+" - "+Chrome.get_message("label_new_subscription"),message:a.thread_title.title,iconUrl:t},!0),Chrome.add_notification_listener(e)}}))}}