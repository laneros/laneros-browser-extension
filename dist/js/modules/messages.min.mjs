import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";export default class Messages{user={};timestamp={};title={};status;participants=[];constructor(){}static check_status(){let e=new Common;Chrome.get_storage({show_inbox:e.get_defaults("show_inbox")},(e=>{e.show_inbox?($(".alert-no-sections").addClass("hidden"),$(".inbox-tab-nav a").removeClass("hidden")):$("#inbox .alert-inbox-message").removeClass("hidden")}))}static get_conversations(){let e=new Common,t=$("#inbox");t.find(".conversation-item:gt(0)").remove(),t.find(".alert-inbox-message").addClass("hidden"),$.getJSON(e.get_page_url("conversations/popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Messages.set_response)}set_user(e){let t=new Common;e.link=e.link.replace("miembros","members"),e.link=t.get_page_url(e.link.substr(1)),1===$(e.avatar).find("img").length?(e.avatar=$(e.avatar).find("img").attr("src"),e.avatar=e.avatar.replace("/avatars/s/","/avatars/m/"),e.figure=!0):(e.avatar=$(e.avatar).find("span").html(),e.figure=!1),this.user=e}set_timestamp(e){this.timestamp=e}set_title(e){let t=new Common;e.link=e.link.replace("conversaciones","conversations"),e.link=t.get_page_url(e.link.substr(1)),this.title=e}set_status(e){this.status=e}set_participants(e){$(e).each(((e,t)=>{let o={id:$(t).find(".username").data("user-id"),username:$(t).find(".username").text()};this.participants.push(o)}))}static set_response(e){let t=$.parseHTML(e.html.content),o=$("#inbox");o.find(".alert-processing").hide(),$(t).find("li.menu-row--separated").length>0?$(t).find("li.menu-row--separated").each(((e,t)=>{let o=new Messages,r={id:$(t).find(".contentRow-figure .avatar").data("user-id"),name:$(t).find(".contentRow-figure .avatar img").attr("alt"),avatar:$(t).find(".contentRow-figure .avatar"),link:$(t).find(".contentRow-figure .avatar").attr("href")},n={title:$(t).find(".contentRow-main .contentRow-minor time").attr("title"),text:$(t).find(".contentRow-main .contentRow-minor time").html()},a={title:$(t).find(".contentRow-main a").html(),link:$(t).find(".contentRow-main a").attr("href")};o.set_timestamp(n),o.set_user(r),o.set_title(a),o.set_participants($(t).find(".contentRow-main .contentRow-minor .listInline--comma li")),o.set_status($(t).hasClass("menu-row--highlighted")),Common.is_background()?o.notify():o.display()})):o.find(".alert-inbox-message").removeClass("hidden")}display(){let e=new Common,t=$("#inbox .conversation-item:first").clone(),o=this.user,r=this.title,n=this.timestamp,a=this.participants,i=r.link.replace("unread","");$(t).find(".conversation-avatar").attr("title",o.name).attr("href",o.link),o.figure?$(t).find(".conversation-avatar > img").attr("src",o.avatar).attr("alt",o.name):$(t).find(".conversation-avatar-avatar > img").addClass("bg-gray-600 border border-gray-900"),this.status&&($(t).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(t).find(".conversation-title").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(t).find(".conversation-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(t).find(".conversation-actions a").removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400"));for(let o in a){let r=$(t).find(".conversation-participant:first").clone(),n=a[o];$(r).find("a").html(n.username).attr("href",e.get_page_url("members/"+n.id)),$(r).removeClass("hidden").appendTo($(t).find(".conversation-with"))}Common.get_user_id()===o.id&&$(t).find(".conversation-actions .conversation-edit").removeClass("hidden").attr("href",i+"edit"),$(t).find(".conversation-actions .conversation-star").attr("href",i+"star"),$(t).find(".conversation-actions .conversation-unread").attr("href",i+"mark-unread"),$(t).find(".conversation-actions .conversation-delete").attr("href",i+"leave"),$(t).find(".conversation-title").html(r.title).attr("href",r.link),$(t).find(".conversation-time").attr("title",n.title).html(n.text),$(t).removeClass("hidden").appendTo("#inbox .conversation-container")}notify(){let e,t=new Common,o=this.user,r=this,n=r.title.link.split("/unread").shift().split(".").pop(),a=Chrome.get_message("extension_short_name")+".Conversations."+n;e=o.figure?o.avatar:"../dist/img/icon.png",Chrome.get_storage({inbox_notification:t.get_defaults("inbox_notification")},(t=>{if(t.inbox_notification&&r.status&&!Common.is_notified(a)){let t=[];Common.set_notifications(a),t[a]={notification_url:r.title.link},Chrome.send_notification(a,{type:"basic",title:Chrome.get_message("extension_short_name")+" - "+Chrome.get_message("label_new_messages"),message:r.title.title,iconUrl:e},!0),Chrome.add_notification_listener(t)}}))}}