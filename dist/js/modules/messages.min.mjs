import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";export default class Messages{message_user={};timestamp={};title={};status;participants=[];constructor(){}static check_status(){const e=new Common;Chrome.get_storage({show_inbox:e.get_defaults("show_inbox")},(e=>{e.show_inbox?($(".alert-no-sections").addClass("hidden"),$(".inbox-tab-nav a").removeClass("hidden")):$("#inbox .alert-inbox-message").removeClass("hidden")}))}static get_conversations(){const e=$("#inbox");e.find(".conversation-item:gt(0)").remove(),e.find(".alert-inbox-message").addClass("hidden"),$.getJSON(Common.get_page_url("conversations/popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Messages.set_response)}set_timestamp(e){this.timestamp=e}set_title(e){e.link=e.link.replace("conversaciones","conversations"),e.link=Common.get_page_url(e.link.substr(1)),this.title=e}set_status(e){this.status=e}set_participants(e){$(e).each(((e,t)=>{const o={id:$(t).find(".username").data("user-id"),username:$(t).find(".username").text()};this.participants.push(o)}))}static set_response(e){const t=$.parseHTML(e.html.content),o=$("#inbox");o.find(".alert-processing").hide(),$(t).find("li.menu-row--separated").length>0?$(t).find("li.menu-row--separated").each(((e,t)=>{const o=new Messages,n={id:$(t).find(".contentRow-figure .avatar").data("user-id"),name:$(t).find(".contentRow-figure .avatar img").attr("alt"),avatar:$(t).find(".contentRow-figure .avatar"),link:$(t).find(".contentRow-figure .avatar").attr("href")},r={title:$(t).find(".contentRow-main .contentRow-minor time").attr("title"),text:$(t).find(".contentRow-main .contentRow-minor time").html()},a={title:$(t).find(".contentRow-main a").html(),link:$(t).find(".contentRow-main a").attr("href")};o.message_user=Common.set_user(n),o.set_timestamp(r),o.set_title(a),o.set_participants($(t).find(".contentRow-main .contentRow-minor .listInline--comma li")),o.set_status($(t).hasClass("menu-row--highlighted")),Common.is_background()?o.notify():o.display()})):o.find(".alert-inbox-message").removeClass("hidden")}display(){const e=$("#inbox .conversation-item:first").clone(),t=this.message_user,o=this.title,n=this.timestamp,r=this.participants,a=o.link.replace("unread","");$(e).find(".conversation-avatar").attr("title",t.name).attr("href",t.link),t.figure?$(e).find(".conversation-avatar > img").attr("src",t.avatar).attr("alt",t.name):$(e).find(".conversation-avatar-avatar > img").addClass("bg-gray-600 border border-gray-900"),this.status&&($(e).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 border-yellow-200 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".conversation-title").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".conversation-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".conversation-actions a").removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400"));for(let t in r){const o=$(e).find(".conversation-participant:first").clone(),n=r[t];$(o).find("a").html(n.username).attr("href",Common.get_page_url("members/"+n.id)),$(o).removeClass("hidden").appendTo($(e).find(".conversation-with"))}Common.get_user_id()===t.id&&$(e).find(".conversation-actions .conversation-edit").removeClass("hidden").attr("href",a+"edit"),$(e).find(".conversation-actions .conversation-star").attr("href",a+"star"),$(e).find(".conversation-actions .conversation-unread").attr("href",a+"mark-unread"),$(e).find(".conversation-actions .conversation-delete").attr("href",a+"leave"),$(e).find(".conversation-title").html(o.title).attr("href",o.link),$(e).find(".conversation-time").attr("title",n.title).html(n.text),$(e).removeClass("hidden").appendTo("#inbox .conversation-container")}notify(){const e=new Common,t=this.message_user,o=this,n=o.title.link.split("/unread").shift().split(".").pop(),r=Chrome.get_message("extension_short_name")+".Conversations."+n;let a;a=t.figure?t.avatar:"../dist/img/extension_icon.png",Chrome.get_storage({inbox_notification:e.get_defaults("inbox_notification")},(e=>{if(e.inbox_notification&&o.status&&!Common.is_notified(r)){const e=[];Common.set_notifications(r),e[r]={notification_url:o.title.link},Chrome.send_notification(r,{type:"basic",title:Chrome.get_message("extension_short_name")+" - "+Chrome.get_message("label_new_messages"),message:o.title.title,iconUrl:a},!0),Chrome.add_notification_listener(e)}}))}}