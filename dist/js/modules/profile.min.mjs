import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";export default class Profile{id;username;title;link;avatar;figure;data={};feedback={};constructor(){}static check_status(){let e=new Common;Chrome.get_storage({show_links:e.get_defaults("show_links")},(e=>{e.show_links?($(".alert-no-sections").addClass("hidden"),$(".home-tab-nav a, .user-links").removeClass("hidden"),$("html, body").animate({scrollTop:0},"fast")):$("#home .alert-home-message").removeClass("hidden")})),Chrome.get_storage({show_user_info:e.get_defaults("show_user_info")},(e=>{let t=$(".section-user").find(".user-info-container");e.show_user_info?$(t).removeClass("hidden"):$(t).addClass("hidden")})),this.get_info()}static get_info(){let e=new Common;$.getJSON(e.get_page_url("account/visitor-menu?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),(e=>{let t=$.parseHTML(e.html.content),s=new Profile;s.set_id($(".contentRow-figure .avatar",t).data("user-id")),s.set_username($(".contentRow-figure .avatar",t).attr("title")),s.set_title($(".contentRow-lesser .userTitle",t).html()),s.set_link($(".contentRow-header a",t).attr("href")),s.set_avatar($(".contentRow-figure .avatar",t)),s.set_data($(".contentRow-minor .fauxBlockLink dd a",t)),s.set_feedback($(".contentRow-minor .feedbackStats dd span",t)),s.display()}))}static set_profile(){let e=$("#statusPoster"),t=new Common;$.getJSON(t.get_page_url("account/privacy?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Profile.set_response),e.find(".status-message").addClass("hidden"),e.find(".status-length").removeClass("text-orange-500 text-red-500").addClass("text-green-500").html("140"),$.validator&&(e.validate({submitHandler:e=>($(e).ajaxSubmit({beforeSubmit:this.before_submit,success:this.success,error:this.error,dataType:"json"}),!1)}),$("#ctrl_pageStatus_visible").on("click",(()=>{$("#visibilityForm").ajaxSubmit({beforeSubmit:this.before_submit,success:this.success,error:this.error,dataType:"json"})}))),$("#message").on("focus",(()=>{e.find(".status-message").removeClass("hidden"),$("html, body").animate({scrollTop:$(document).height()},"slow")})).on("keyup",(t=>{let s=t.currentTarget,r=$(s).val().length;r<=140?e.find(".status-length").html((140-r).toString()):($(s).val($(s).val().substr(0,140)),e.find(".status-length").html("0")),r>100&&r<=120?e.find(".status-length").removeClass("text-green-500 text-orange-400 text-red-500").addClass("text-orange-400"):r>120&&e.find(".status-length").removeClass("text-green-500 text-orange-400 text-red-500").addClass("text-red-500")}))}static set_response(e){let t=$.parseHTML(e.html.content);$("input[name*=visible]:first",t).is(":checked")&&$("#ctrl_pageStatus_visible").prop("checked",!0),$("#home .alert-processing").slideUp()}static before_submit(){$(".alert-home-message").slideUp(),$("#home .alert-processing").removeClass("hidden").hide().slideDown()}static success(e){"ok"===e.status?($(".alert-home-message").addClass("bg-green-100 border-green-500 text-green-500").removeClass("bg-red-100 border-red-500 text-red-500").slideDown(),$(".alert-home-message h4").html(Chrome.get_message("label_success_message")),$(".alert-home-message p").html(e.message)):($(".alert-home-message").addClass("bg-red-100 border-red-500 text-red-500").removeClass("bg-green-100 border-green-500 text-green-500").slideDown(),$(".alert-home-message h4").html(Chrome.get_message("label_error_message")),$(".alert-home-message p").html(e.error.message))}static error(e){let t=JSON.parse(e.responseText);$("#home .alert-processing").slideUp((()=>{$("#home .alert-processing").addClass("hidden"),$(".alert-home-message").slideDown(),$(".alert-home-message p").html(t.errors.shift())}))}set_id(e){this.id=e}set_username(e){this.username=e}set_title(e){this.title=e}set_link(e){let t=new Common;e=e.replace("miembros","members"),this.link=t.get_page_url(e.substr(1))}set_avatar(e){1===$(e).find("img").length?(this.avatar=$(e).find("img").attr("src"),this.figure=!0):(this.avatar=$(e).find("span").html(),this.figure=!1)}set_data(e){let t=this.data;$(e).each((function(e,s){let r=$.trim($(s).text().replaceAll(",",""));switch(r=new Intl.NumberFormat("de-DE").format(parseInt(r)),e){case 0:t.messages=r;break;case 1:t.rating=r;break;case 2:t.points=r}}))}set_feedback(e){let t=this.feedback;$(e).each((function(e,s){let r=$.trim($(s).text().replaceAll(",",""));switch(r=new Intl.NumberFormat("de-DE").format(parseInt(r)),e){case 0:t.positive=r;break;case 1:t.neutral=r;break;case 2:t.negative=r}}))}get_full_id(){return this.username+"."+this.id}display(){let e=$(".section-user"),t=$(e).find(".user-info-container"),s=$(t).find(".user-info"),r=$(t).find(".user-data");$(s).find("a").html(this.username),$(s).find("small").html(this.title),this.figure?$(t).find(".avatar > img").attr("src",this.avatar).attr("alt",this.username):$(t).find(".avatar > img").addClass("bg-gray-600 border border-gray-900"),$(r).find(".user-messages").html(this.data.messages),$(r).find(".user-rating").html(this.data.rating),$(r).find(".user-points").html(this.data.points),$(r).find(".user-feedback-positive").html(this.feedback.positive),$(r).find(".user-feedback-neutral").html(this.feedback.neutral),$(r).find(".user-feedback-negative").html(this.feedback.negative),$(".user-full-id").each(((e,t)=>{if(void 0!==$(t).attr("href")){let e=$(t).attr("href").replace("{user-full-id}",this.get_full_id());$(t).attr("href",e)}if(void 0!==$(t).attr("action")){let e=$(t).attr("action").replace("{user-full-id}",this.get_full_id());$(t).attr("action",e)}})),$(".user-id").each(((e,t)=>{if(void 0!==$(t).attr("href")){let e=$(t).attr("href").replace("{user-id}",this.id.toString());$(t).attr("href",e)}if(void 0!==$(t).attr("action")){let e=$(t).attr("action").replace("{user-id}",this.id.toString());$(t).attr("action",e)}})),$(".token-value").each(((e,t)=>{if(void 0!==$(t).attr("href")){let e=$(t).attr("href").replace("{token-value}",Common.get_token());$(t).attr("href",e)}if(void 0!==$(t).attr("action")){let e=$(t).attr("action").replace("{token-value}",Common.get_token());$(t).attr("action",e)}void 0!==$(t).is(":input")&&$(t).val(Common.get_token())})),$(t).removeClass("hidden")}}