import*as JQuery from"../../../vendor/js/jquery-3.5.1.min.js";import*as jQueryForm from"../../../vendor/js/jquery.form.min.js";import*as jQueryValidate from"../../../vendor/js/jquery.validate.min.js";import Chrome from"./chrome.min.mjs";import Log from"./log.min.mjs";import Login from"./login.min.mjs";import Profile from"./profile.min.mjs";import Messages from"./messages.min.mjs";import Alerts from"./alerts.min.mjs";import Subscriptions from"./subscriptions.min.mjs";import Bookmarks from"./bookmarks.min.mjs";export default class Common{static user_id;static site_token;static source;static notifications=[];static counter={};static page_url="https://www.laneros.com/";active_tab="home";review_time=12e4;show_inbox=!0;show_alerts=!0;show_subscriptions=!0;show_bookmarks=!0;show_links=!0;show_user_info=!0;single_notification=!0;inbox_notification=!1;alerts_notification=!1;subscriptions_notification=!1;constructor(){}check_dark_mode(){window.matchMedia("(prefers-color-scheme: dark)").matches&&$("html").addClass("dark")}set_ui_language(){const e=Chrome.get_ui_language().split("-");$("html").attr("lang",e.shift())}parse_messages(){$(document).find("[data-i18n]").each(((e,t)=>{const[o,r]=$(t).data("i18n").split(","),s=o.split("|"),i=r.split("|");for(let e=0;e<s.length;e++){const o=s[e],r=Chrome.get_message(i[e]);"html"===o?$(t).html(r):$(t).attr(o,r)}$(t).removeAttr("data-i18n")}))}parse_html(){$(document).find(".external-link").each(((e,t)=>{$(t).is("a")&&$(t).attr("href",Common.get_page_url($(t).attr("href"))).attr("target","_blank"),$(t).is("form")&&$(t).attr("action",Common.get_page_url($(t).attr("action"))),$(t).is("img")&&$(t).attr("src",Common.get_page_url($(t).attr("src")))}))}set_validator(){$.validator&&$.validator.setDefaults({highlight:e=>{$(e).addClass("border-red-600 focus:border-red-600 dark:border-red-500 dark:focus:border-red-500").removeClass("border-green-600 focus:border-green-600 dark:border-green-500 dark:focus:border-green-500"),$("label[for="+$(e).attr("id")+"]").addClass("text-red-600 dark:text-red-500").removeClass("text-green-600 dark:text-green-500")},unhighlight:e=>{$(e).removeClass("border-red-600 focus:border-red-600 dark:border-red-500 dark:focus:border-red-500").addClass("border-green-600 focus:border-green-600 dark:border-green-500 dark:focus:border-green-500"),$("label[for="+$(e).attr("id")+"]").removeClass("text-red-600 dark:text-red-500").addClass("text-green-600 dark:text-green-500"),$(e).closest(".text-base").find("small").addClass("invisible")},errorPlacement:(e,t)=>{$(t).closest(".text-base").find("small").removeClass("invisible")}})}get_defaults(e=null){const t={active_tab:this.active_tab,review_time:this.review_time,show_inbox:this.show_inbox,show_alerts:this.show_alerts,show_subscriptions:this.show_subscriptions,show_bookmarks:this.show_bookmarks,show_links:this.show_links,show_user_info:this.show_user_info,single_notification:this.single_notification,inbox_notification:this.inbox_notification,alerts_notification:this.alerts_notification,subscriptions_notification:this.subscriptions_notification};return null!==e?t[e]:t}create_notification(e,t,o){const r=(e,t)=>{let o;switch(t){case 0:o=Common.get_page_url();break;default:o=Common.get_page_url("account")}Chrome.query_tab(o,(e=>{const t=e.shift();0===e.length?Chrome.create_tab(2,o):Chrome.highlight_tab(t.windowId,t.index)}))},s={title:Chrome.get_message("label_conversations"),message:Chrome.get_message("message_zero_inbox")},i={title:Chrome.get_message("label_alerts"),message:Chrome.get_message("message_zero_alerts")},n={title:Chrome.get_message("label_subscriptions"),message:Chrome.get_message("message_zero_subscriptions")};let a=[];e>0&&(s.message=e+" "+Chrome.get_message("text_new_conversation")),t>0&&(i.message=t+" "+Chrome.get_message("text_new_alert")),o>0&&(n.message=o+" "+Chrome.get_message("text_new_subscription")),a.push(s),a.push(i),a.push(n),Chrome.send_notification(Chrome.get_message("extension_short_name"),{type:"list",title:Chrome.get_message("extension_name"),message:Chrome.get_message("extension_description"),iconUrl:"../dist/img/extension_icon.png",items:a,buttons:[{title:Chrome.get_message("button_homepage")},{title:Chrome.get_message("button_account")}]},(()=>{chrome.notifications.onButtonClicked.addListener(r)}),!0)}static check_data(e=!1){const t=new Common;Common.set_source(e),$(".search-form button").on("click",(()=>{const e={"c[users]":"","c[newer_than]":"","c[older_than]":"","c[tags]":"","c[excludeTags]":"",order:"relevance",keywords:$("#keywords").val(),_xfToken:Common.get_token(),_xfResponseType:"json"};$.post(Common.get_page_url("search/search"),e,(e=>{"ok"===e.status?Chrome.create_tab(2,e.redirect):$("#keywords").closest("div").find("small").removeClass("invisible")}))})),$.get(Common.get_page_url("watched/threads")).done((o=>{try{const r=$(".p-account .avatar",o).data("user-id"),s=parseInt($(".p-account .js-badge--conversations",o).data("badge")),i=parseInt($(".p-account .js-badge--alerts",o).data("badge")),n=parseInt($(".structItemContainer .is-unread",o).length),a=s+i+n,m=$("input[name=_xfToken]:first",o).val();Common.set_token(m),Common.set_counter({conversations:s,alerts:i,subscriptions:n}),Common.set_user_id(r),e?(Messages.get_conversations(),Alerts.get_alerts(),Subscriptions.get_threads()):($("body").css("height","auto"),$(".loading-box").fadeOut((()=>{$(".section-user").removeClass("hidden").hide().fadeIn("fast"),$("header").removeClass("hidden")})),s>0&&$(".inbox-counter").removeClass("invisible").html(s.toString()),i>0&&$(".alert-counter").removeClass("invisible").html(i.toString()),n>0&&$(".subscription-counter").removeClass("invisible").html(n.toString()),Common.check_tabs_status(),Common.check_active_tab()),Chrome.get_badge((e=>{e=parseInt(e),Chrome.set_badge(a),(isNaN(e)||e<a)&&Chrome.get_storage({single_notification:t.get_defaults("single_notification")},(e=>{e.single_notification&&t.create_notification(s,i,n)}))}))}catch(e){new Log("ajax-success").error(e)}})).fail((e=>{try{if($(".popup-page").css("height","auto"),403===e.status){const t=$($.parseHTML(e.responseText)).find("input[name=_xfToken]:first").val();Common.set_token(t),new Login}else $(".loading-box").fadeOut((()=>{$(".section-error, header").removeClass("hidden")}))}catch(e){new Log("Common get_data - ajax-error").error(e)}}))}static set_token(e){Common.site_token=e}static get_token(){return Common.site_token}static set_user_id(e){Common.user_id=e}static get_user_id(){return Common.user_id}static check_tabs_status(){Profile.check_status(),Messages.check_status(),Alerts.check_status(),Subscriptions.check_status(),Bookmarks.check_status()}static check_active_tab(){const e=new Common;Chrome.get_storage({active_tab:e.get_defaults("active_tab")},(e=>{const t=$('a[href="#'+e.active_tab+'"]');let o;$(t).hasClass("hidden")?(o=$(".tab-list").find("a:not(.hidden):first"),$(o).addClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white dark:text-white dark:hover:bg-gray-600").removeClass("text-blue-500 hover:bg-gray-400 hover:text-gray-100 dark:text-blue-400 dark:hover:text-blue-100 dark:hover:bg-gray-600"),o=$(o).attr("href")):(o="#"+e.active_tab,$(t).addClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white dark:text-white dark:hover:bg-gray-600").removeClass("text-blue-500 hover:bg-gray-400 hover:text-gray-100 dark:text-blue-400 dark:hover:text-blue-100 dark:hover:bg-gray-600")),void 0!==typeof o?($(o).find(".loading-data").removeClass("hidden"),this.active_tab_opt(o.replace("#",""))):($("body").css("height","auto"),$(".alert-no-sections").removeClass("hidden"))}))}static active_tab_opt(e){switch($(".tab").addClass("hidden"),e){case"home":$(".home-tab").removeClass("hidden"),Profile.set_profile();break;case"inbox":$(".inbox-tab").removeClass("hidden"),Messages.get_conversations();break;case"alerts":$(".alerts-tab").removeClass("hidden"),Alerts.get_alerts();break;case"subscriptions":$(".subscriptions-tab").removeClass("hidden"),Subscriptions.get_threads();break;case"bookmarks":$(".bookmarks-tab").removeClass("hidden"),Bookmarks.get_bookmarks()}}static set_source(e){Common.source=e}static is_background(){return Common.source}static set_notifications(e){Common.notifications.push(e)}static is_notified(e){return Common.notifications.includes(e)}static set_counter(e){this.counter=e}static get_counter(e){return null!==e?Common.counter[e]:Common.counter}static set_user(e){return e.link=e.link.replace("miembros","members"),e.link=Common.get_page_url(e.link.substr(1)),1===$(e.avatar).find("img").length?(e.avatar=$(e.avatar).find("img").attr("src"),e.avatar=e.avatar.replace("/avatars/s/","/avatars/m/"),e.figure=!0):(e.avatar=$(e.avatar).find("span").html(),e.figure=!1),e}static get_page_url(e=null){return null!==e?this.page_url+e:this.page_url}}