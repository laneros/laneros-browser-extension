import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";import Log from"./log.min.mjs";export default class Alerts{id;content;content_text;alert_user={};timestamp={};status;constructor(){}static check_status(){const e=new Common;Chrome.get_storage({show_alerts:e.get_defaults("show_alerts")},(e=>{e.show_alerts?($(".alert-no-sections").addClass("hidden"),$(".alerts-tab-nav a").removeClass("hidden")):$("#alerts .alert-alerts-message").removeClass("hidden")}))}static get_alerts(){const e=$("#alerts");e.find(".alert-item:gt(0)").remove(),e.find(".alert-alert-message").addClass("hidden"),$.getJSON(Common.get_page_url("account/alerts-popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Alerts.set_response)}set_content(e){let r=$(e).find(".username").attr("href"),t=$(e).find(".fauxBlockLink-blockLink").attr("href");1===$(e).find(".username").length&&(r.replace("miembros","members"),r=Common.get_page_url(r.substr(1))),t=Common.get_page_url(t.substr(1)),$(e).find(".username").attr("href",r).removeClass().removeAttr("dir itemprop data-user-id data-xf-init").attr("title",this.alert_user.name).attr("target","_blank").addClass("text-blue-500 hover:text-blue-600"),$(e).find(".fauxBlockLink-blockLink").attr("href",t).removeClass().attr("target","_blank").addClass("text-blue-500 hover:text-blue-600"),$(e).find(".contentRow-minor, i").remove(),$(e).find("img").removeClass().addClass("inline-block"),$(e).find("bdi").removeClass().addClass("font-bold text-yellow-400 dark:text-yellow-500"),this.content=$(e).html(),this.content_text=$(e).text()}set_id(e){this.id=parseInt(e)}set_timestamp(e){this.timestamp=e}set_status(e){this.status=e}static set_response(e){const r=$.parseHTML(e.html.content),t=$("#alerts");t.find(".alert-processing").hide(),$(r).find("li.menu-row--separated").length>0?$(r).find("li.menu-row--separated").each(((e,r)=>{const t=new Alerts,o={id:$(r).find(".contentRow-figure .avatar").data("user-id"),name:$(r).find(".contentRow-main .username").html(),avatar:$(r).find(".contentRow-figure .avatar"),link:$(r).find(".contentRow-figure .avatar").attr("href")},a={title:$(r).find(".contentRow-main .contentRow-minor time").attr("title"),text:$(r).find(".contentRow-main .contentRow-minor time").html()};t.alert_user=Common.set_user(o),t.set_id($(r).data("alert-id")),t.set_timestamp(a),t.set_status($(r).hasClass("is-unread")),t.set_content($(r).find(".contentRow-main")),Common.get_counter("alerts")>e&&t.set_status(!0),Common.is_background()?t.notify():t.display()})):t.find(".alert-alerts-message").removeClass("hidden")}display(){const e=$("#alerts .alert-item:first").clone(),r=this.alert_user,t=this.timestamp;let o=$(e).find(".alert-mark").attr("href");o&&(o=o.replace("{alert-id}",this.id.toString())),this.status&&($(e).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 border-yellow-200 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_read")).removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")),r.figure?$(e).find(".alert-avatar > img").attr("src",r.avatar).attr("alt",r.name):$(e).find(".alert-avatar > img").addClass("bg-gray-600 border border-gray-900"),this.set_actions(e),$(e).find(".alert-avatar").attr("title",r.name).attr("href",r.link),$(e).find(".alert-body").html(this.content),$(e).find(".alert-time").attr("title",t.title).html(t.text),$(e).find(".alert-mark").attr("href",o),$(e).removeClass("hidden").appendTo("#alerts .alert-container")}set_actions(e){const r=this;$(e).find(".alert-mark").on("click",(t=>{const o=t.currentTarget,a={unread:r.status?0:1,_xfToken:Common.get_token(),_xfResponseType:"json"};return t.preventDefault(),$(o).addClass("animate-pulse"),$.post($(o).attr("href"),a,(t=>{$(o).removeClass("animate-pulse"),"ok"===t.status&&(r.status?(r.set_status(!1),$(e).addClass("border-gray-200 dark:border-gray-700").removeClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").removeClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_read")).addClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").removeClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")):(r.set_status(!0),$(e).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_unread")).removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")))})),!1}))}notify(){const e=new Common,r=this.alert_user,t=this,o=Chrome.get_message("extension_short_name")+".Alerts."+t.id;let a;a=r.figure?r.avatar:"../dist/img/extension_icon.png",Chrome.get_storage({alerts_notification:e.get_defaults("alerts_notification")},(e=>{if(e.alerts_notification&&t.status&&!Common.is_notified(o)){const e=[];Common.set_notifications(o),e[o]={notification_url:Common.get_page_url("account/alerts")},Chrome.send_notification(o,{type:"basic",title:Chrome.get_message("extension_short_name")+" - "+Chrome.get_message("label_new_alerts"),message:t.content_text,iconUrl:a},!0),Chrome.add_notification_listener(e)}}))}}