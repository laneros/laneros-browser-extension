import Chrome from"./chrome.min.mjs";import Common from"./common.min.mjs";export default class Alerts{id;content;content_text;alert_user={};timestamp={};status;constructor(){}static check_status(){let e=new Common;Chrome.get_storage({show_alerts:e.get_defaults("show_alerts")},(e=>{e.show_alerts?($(".alert-no-sections").addClass("hidden"),$(".alerts-tab-nav a").removeClass("hidden")):$("#alerts .alert-alerts-message").removeClass("hidden")}))}static get_alerts(){let e=new Common,r=$("#alerts");r.find(".alert-item:gt(0)").remove(),r.find(".alert-alert-message").addClass("hidden"),$.getJSON(e.get_page_url("account/alerts-popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+Common.get_token()),Alerts.set_response)}set_alert_user(e){let r=new Common;e.link=e.link.replace("miembros","members"),e.link=r.get_page_url(e.link.substr(1)),1===$(e.avatar).find("img").length?(e.avatar=$(e.avatar).find("img").attr("src"),e.avatar=e.avatar.replace("/avatars/s/","/avatars/m/"),e.figure=!0):(e.avatar=$(e.avatar).find("span").html(),e.figure=!1),this.alert_user=e}set_content(e){let r=new Common,t=$(e).find(".username").attr("href"),a=$(e).find(".fauxBlockLink-blockLink").attr("href");1===$(e).find(".username").length&&(t.replace("miembros","members"),t=r.get_page_url(t.substr(1))),a=r.get_page_url(a.substr(1)),$(e).find(".username").attr("href",t).removeClass().removeAttr("dir itemprop data-user-id data-xf-init").attr("title",this.alert_user.name).attr("target","_blank").addClass("text-blue-500 hover:text-blue-600"),$(e).find(".fauxBlockLink-blockLink").attr("href",a).removeClass().attr("target","_blank").addClass("text-blue-500 hover:text-blue-600"),$(e).find(".contentRow-minor, i").remove(),$(e).find("img").removeClass().addClass("inline-block"),$(e).find("bdi").removeClass().addClass("font-bold text-yellow-400 dark:text-yellow-500"),this.content=$(e).html(),this.content_text=$(e).text()}set_id(e){this.id=e}set_timestamp(e){this.timestamp=e}set_status(e){this.status=e}static set_response(e){let r=$.parseHTML(e.html.content),t=$("#alerts");t.find(".alert-processing").hide(),$(r).find("li.menu-row--separated").length>0?$(r).find("li.menu-row--separated").each(((e,r)=>{let t=new Alerts,a={id:$(r).find(".contentRow-figure .avatar").data("user-id"),name:$(r).find(".contentRow-main .username").html(),avatar:$(r).find(".contentRow-figure .avatar"),link:$(r).find(".contentRow-figure .avatar").attr("href")},o={title:$(r).find(".contentRow-main .contentRow-minor time").attr("title"),text:$(r).find(".contentRow-main .contentRow-minor time").html()};t.set_id($(r).data("alert-id")),t.set_timestamp(o),t.set_alert_user(a),t.set_status($(r).hasClass("is-unread")),t.set_content($(r).find(".contentRow-main")),Common.get_counter("alerts")>e&&t.set_status(!0),Common.is_background()?t.notify():t.display()})):t.find(".alert-alerts-message").removeClass("hidden")}display(){let e=$("#alerts .alert-item:first").clone(),r=$(e).find(".alert-mark").attr("href"),t=this.alert_user,a=this.timestamp;r&&(r=r.replace("{alert-id}",this.id.toString())),this.status&&($(e).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_read")).removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")),t.figure?$(e).find(".alert-avatar > img").attr("src",t.avatar).attr("alt",t.name):$(e).find(".alert-avatar > img").addClass("bg-gray-600 border border-gray-900"),this.set_actions(e),$(e).find(".alert-avatar").attr("title",t.name).attr("href",t.link),$(e).find(".alert-body").html(this.content),$(e).find(".alert-time").attr("title",a.title).html(a.text),$(e).find(".alert-mark").attr("href",r),$(e).removeClass("hidden").appendTo("#alerts .alert-container")}set_actions(e){let r=this;$(e).find(".alert-mark").on("click",(t=>{let a=t.currentTarget,o={unread:r.status?0:1,_xfToken:Common.get_token(),_xfResponseType:"json"};return t.preventDefault(),$(a).addClass("animate-pulse"),$.post($(a).attr("href"),o,(t=>{$(a).removeClass("animate-pulse"),"ok"===t.status&&(r.status?(r.set_status(!1),$(e).addClass("border-gray-200 dark:border-gray-700").removeClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").removeClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_read")).addClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").removeClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")):(r.set_status(!0),$(e).removeClass("border-gray-200 dark:border-gray-700").addClass("bg-yellow-100 dark:border-yellow-300 dark:text-gray-500 bg-opacity-95"),$(e).find(".alert-body").addClass("text-gray-600 hover:text-gray-900 dark:text-gray-600 dark:hover:text-gray-900"),$(e).find(".alert-actions a").attr("title",Chrome.get_message("button_mark_unread")).removeClass("text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border-gray-400 bg-gray-100 dark:border-gray-600 dark:bg-gray-900 hover:border-gray-800").addClass("text-yellow-400 dark:text-yellow-500 hover:text-yellow-800 dark:hover:text-yellow-600 border-yellow-300 bg-yellow-200 dark:border-yellow-300 dark:bg-yellow-200 hover:border-yellow-400")))})),!1}))}notify(){let e,r=new Common,t=this.alert_user,a=this,o=Chrome.get_message("extension_short_name")+".Alerts."+a.id;e=t.figure?t.avatar:"../dist/img/icon.png",Chrome.get_storage({alerts_notification:r.get_defaults("alerts_notification")},(t=>{if(t.alerts_notification&&a.status&&!Common.is_notified(o)){let t=[];Common.set_notifications(o),t[o]={notification_url:r.get_page_url("account/alerts")},Chrome.send_notification(o,{type:"basic",title:Chrome.get_message("extension_short_name")+" - "+Chrome.get_message("label_new_alerts"),message:a.content_text,iconUrl:e},!0),Chrome.add_notification_listener(t)}}))}}