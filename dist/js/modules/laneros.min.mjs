import*as e from"../../../vendor/js/jquery-3.5.1.min.js";import*as t from"../../../vendor/js/jquery.form.min.js";import*as a from"../../../vendor/js/jquery.validate.min.js";import s from"./chrome.min.mjs";import i from"./common.min.mjs";export default class r{user_data={};counter={};constructor(e,t,a){let r=new i,n=this,o=function(e){switch(e){case"home":$(".home-tab, .user-links").removeClass("hidden"),n.show_profile_links();break;case"inbox":$(".inbox-tab").removeClass("hidden"),n.get_conversations();break;case"alerts":$(".alerts-tab").removeClass("hidden"),n.get_alerts();break;case"subscriptions":$(".subscriptions-tab").removeClass("hidden"),n.get_subscriptions();break;case"bookmarks":$(".bookmarks-tab").removeClass("hidden"),n.get_bookmarks()}};this.user_data=Object.assign(this.user_data,{user_id:e,token:t}),this.counter=a,this.counter.conversations>0&&$(".inbox-counter").removeClass("invisible").html(this.counter.conversations),this.counter.alerts>0&&$(".alert-counter").removeClass("invisible").html(this.counter.alerts),this.counter.subscriptions>0&&$(".subscription-counter").removeClass("invisible").html(this.counter.subscriptions),$("body").css("height","auto"),$(".loading-box").fadeOut((function(){$(".section-user").removeClass("hidden").hide().fadeIn("fast"),$("header").removeClass("hidden")})),$(".user-id").each((function(){if(void 0!==$(this).attr("href")){let e=$(this).attr("href").replace("{user-id}",n.user_data.user_id);$(this).attr("href",e)}if(void 0!==$(this).attr("action")){let e=$(this).attr("action").replace("{user-id}",n.user_data.user_id);$(this).attr("action",e)}})),$(".token-value").each((function(){if(void 0!==$(this).attr("href")){let e=$(this).attr("href").replace("{token-value}",n.user_data.token);$(this).attr("href",e)}if(void 0!==$(this).attr("action")){let e=$(this).attr("action").replace("{token-value}",n.user_data.token);$(this).attr("action",e)}void 0!==$(this).is(":input")&&$(this).val(n.user_data.token)})),$(".tab-list a").on("click",(function(e){if(e.preventDefault(),!$(this).hasClass("cursor-not-allowed")){let e=$(this).attr("href").replace("#",""),t={active_tab:e};s.set_storage(t,o(e)),$(".tab-list a").removeClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white").addClass("text-blue-500 hover:text-blue-600 hover:bg-gray-400"),$(this).addClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white").removeClass("text-blue-500 hover:bg-gray-400 hover:text-blue-600"),$(".tab-content .tab").addClass("hidden"),$("#"+e).removeClass("hidden").find(".loading-data").removeClass("hidden").hide().fadeIn()}return!1})),this.get_user_info(),this.show_profile_links(),this.get_conversations(),this.get_alerts(),this.get_subscriptions(),this.get_bookmarks(),s.get_storage({active_tab:r.get_defaults("active_tab")},(function(e){let t,a=$('a[href="#'+e.active_tab+'"]');$(a).hasClass("hidden")?(t=$(".tab-list").find("a:not(.hidden):first"),$(t).addClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white").removeClass("text-blue-500 hover:bg-gray-400 hover:text-blue-600"),t=$(t).attr("href")):(t="#"+e.active_tab,$(a).addClass("text-white bg-blue-500 hover:bg-blue-600 hover:text-white").removeClass("text-blue-500 hover:bg-gray-400 hover:text-blue-600")),void 0!==t?($(t).find(".loading-data").removeClass("hidden"),o(t.replace("#",""))):($("body").css("height","auto"),$(".alert-no-sections").removeClass("hidden"))}))}static set_validator(){$.validator&&$.validator.setDefaults({errorElement:"div",highlight:function(e){$(e).addClass("border-red-600 is-invalid").closest(".flex").find("*").removeClass("border-green-600").addClass("border-red-600").closest(".pb-5").addClass("text-red-600").removeClass("text-green-600")},unhighlight:function(e){0===$(e).closest(".flex").find(".is-invalid").length&&$(e).closest(".flex").find("*").removeClass("border-red-600").addClass("border-green-600").closest(".pb-5").addClass("text-green-600").removeClass("text-red-600")},errorClass:"text-red-500 text-xs",errorPlacement:function(e,t){$(t).closest(".mt-3").find("small").removeClass("invisible")}})}static show_login(e){s.set_badge(0),$(".section-login input[name=register]").change((function(){let e=$(".section-login #ctrl_pageLogin_password"),t=$(".section-login #ctrl_pageLogin_remember");e.closest(".flex-row").slideUp(),t.attr("checked",!1).closest("div").hide(),$(".section-login #ctrl_pageLogin_not_registered").is(":checked")&&$(".section-login button[type=submit]").html(s.get_message("button_register")),$(".section-login #ctrl_pageLogin_registered").is(":checked")&&(e.closest(".flex-row").slideDown(),t.closest("div").show(),$(".section-login button[type=submit]").html(s.get_message("button_login")))})),$(".section-login input[name=_xfToken]").val(e),$.validator&&$("#pageLogin").validate({submitHandler:function(e){return $(e).ajaxSubmit({beforeSubmit:function(){$("#pageLogin .alert-response-error").slideUp(),$("#pageLogin .alert-processing").slideDown()},success:function(e){$("#pageLogin .alert-processing").slideUp(),void 0!==e.html?($("#pageLogin .alert-response-error").slideDown(),$("#pageLogin .alert-response-error p").html(s.get_message("text_error_login"))):void 0!==e.message&&""!==e.message?($("#pageLogin .alert-response-error").slideDown(),$("#pageLogin .alert-response-error p").html(e.message)):$("#pageLogin .alert-response-success").slideDown((function(){$(".section-login").fadeOut("fast"),i.check_data(!0)}))},error:function(){$("#pageLogin .alert-response").slideDown(),$("#pageLogin .alert-response p").html(s.get_message("text_error_message")),$("#pageLogin .alert-processing").slideUp()},dataType:"json"}),!1}}),$(".loading-box").fadeOut((function(){$(".section-login").fadeIn("fast"),$("header").removeClass("hidden")}))}get_user_info(){let e=new i,t=this;s.get_storage({show_user_info:e.get_defaults("show_user_info")},(function(a){let s=$(".section-user"),i=$(s).find(".user-info-container");if(a.show_user_info){let a=document.createElement("div"),r=function(e){a=$(e.html.content),$("input[name*=visible]:first",a).is(":checked")&&$("#ctrl_pageStatus_visible").attr("checked",!0)},n=function(e){let r=$(i).find(".user-info"),n=$(i).find(".user-data");a=$(e.html.content);let o=$(".avatarWrapper .avatar img",a).attr("src"),l=$(".contentRow-minor .fauxBlockLink:first dd a",a).html(),d=$(".contentRow-minor .fauxBlockLink:eq(1) dd a",a).html(),h=$(".contentRow-minor .fauxBlockLink:eq(2) dd a",a).html(),m=$(".contentRow-minor .feedbackStats dd .Positive",a).text(),f=$(".contentRow-minor .feedbackStats dd .Neutral",a).text(),c=$(".contentRow-minor .feedbackStats dd .Negative",a).text();t.user_data=Object.assign(t.user_data,{username:$(".contentRow-header a.username",a).text(),title:$(".contentRow-lesser .userTitle",a).text(),full_id:$(".contentRow-header a.username",a).text()+"."+t.user_data.user_id}),$(s).find(".user-id-full").each((function(){if(void 0!==$(this).attr("href")){let e=$(this).attr("href").replace("{user-id-full}",t.user_data.full_id);$(this).attr("href",e)}if(void 0!==$(this).attr("action")){let e=$(this).attr("action").replace("{user-id-full}",t.user_data.full_id);$(this).attr("action",e)}})),$(r).find("a").html(t.user_data.username),$(r).find("small").html(t.user_data.title),$(i).find(".avatar").attr("src",o),$(n).find(".user-messages").html(l),$(n).find(".user-rating").html(d),$(n).find(".user-points").html(h),$(n).find(".user-feedback-positive").html(m||0),$(n).find(".user-feedback-neutral").html(f||0),$(n).find(".user-feedback-negative").html(c||0),$(i).removeClass("hidden")};$.getJSON(e.get_page_url()+"account/visitor-menu?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,n),$.getJSON(e.get_page_url()+"account/privacy?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,r)}else $(i).addClass("hidden")}))}show_profile_links(){let e=new i;s.get_storage({show_links:e.get_defaults("show_links")},(function(e){if(e.show_links){let e=$("#statusPoster"),t=function(e,t){$(".alert-home-message").slideUp()},a=function(e,t){"ok"===e.status?($(".alert-home-message").addClass("bg-green-100 border-green-500 text-green-500").removeClass("bg-red-100 border-red-500 text-red-500").slideDown(),$(".alert-home-message h4").html(s.get_message("label_success_message")),$(".alert-home-message p").html(e.message)):($(".alert-home-message").addClass("bg-red-100 border-red-500 text-red-500").removeClass("bg-green-100 border-green-500 text-green-500").slideDown(),$(".alert-home-message h4").html(s.get_message("label_error_message")),$(".alert-home-message p").html(e.error.message))},i=function(e,t){$(".alert-home-message").slideDown(),$(".alert-home-message h4").html(s.get_message("label_error_message")),$(".alert-home-message p").html(s.get_message("text_error_message"))};e.find(".status-message").addClass("hidden"),e.find(".status-length").removeClass("text-orange-500 text-red-500").addClass("text-green-500").html(140),$.validator&&(e.validate({submitHandler:function(e){return $(e).ajaxSubmit({beforeSubmit:t,success:a,error:i,dataType:"json"}),!1}}),$("#ctrl_pageStatus_visible").click((function(){$("#visibilityForm").ajaxSubmit({beforeSubmit:t,success:a,error:i,dataType:"json"})}))),$("#message").on("focus",(function(){e.find(".status-message").removeClass("hidden"),$("html, body").animate({scrollTop:$(document).height()},"slow")})).on("focusout",(function(){e.find(".status-message").addClass("hidden")})).on("keyup",(function(){let t=$(this).val().length;t<=140?e.find(".status-length").html(140-t):($(this).val($(this).val().substr(0,140)),e.find(".status-length").html(0)),t>100&&e.find(".status-length").removeClass("text-green-500").addClass("text-orange"),t>120&&e.find(".status-length").removeClass("text-green-500 text-orange").addClass("text-red-500")})),$("html, body").animate({scrollTop:0},"fast"),$(".alert-no-sections").addClass("hidden"),$(".home-tab-nav a").removeClass("hidden")}else $(".alert-home-message").removeClass("hidden")}))}get_conversations(){let e=new i,t=this;s.get_storage({show_inbox:e.get_defaults("show_inbox")},(function(a){let i=$("#inbox");if(a.show_inbox){let a=function(t){let a=document.createElement("div"),r=!1;$(a).html(t.html.content),i.find(".conversation-item:gt(0)").remove(),i.find(".loading-data").hide(),0===$(a).find("div.menu-row").length&&$(a).find("li.menu-row--separated").each((function(){let t=i.find(".conversation-item:first").clone(),a=$(this).find(".contentRow-main a"),n=$(this).find(".contentRow-figure"),o=$(n).find("a.avatar img"),l=$(this).find(".contentRow-main .contentRow-minor--hideLinks"),d=$(l).find("ul"),h=$(this).find(".contentRow-main .contentRow-minor--smaller time");$(this).hasClass("menu-row--highlighted")&&(r=!0,$(t).addClass("bg-yellow-100"),$(t).find(".conversation-body h6 a").addClass("text-gray-600 hover:text-gray-900")),1===$(o).length?$(t).find(".conversation-avatar > img").attr("src",$(o).attr("src")).attr("alt",$(o).attr("alt")):$(t).find(".conversation-avatar > img").addClass("bg-gray-600 border border-gray-900"),$(l).find("ul").remove(),$(t).find(".conversation-avatar").attr("href",$(n).find("a.avatar").attr("href")),$(t).find(".conversation-title").html(a.html()).attr("href",a.attr("href")),$(t).find(".conversation-with").html($(l).text()),$(t).find(".conversation-time").html($(h).html()).attr("title",$(h).attr("title")),$(d).find("li").each((function(e){let a=document.createElement("a"),s=$(t).find(".conversation-with"),i=$(this).find("span:first"),r=$(i).text(),n=$(i).data("user-id"),o=$(i).attr("title");$(a).html(r).attr("title",o).attr("href","members/"+r+"."+n),$(a).appendTo(s),e<$(d).find("li").length-1&&$(s).append(", ")})),$(t).find(".conversation-with a").addClass("text-blue-500 hover:text-blue-600"),$(t).find("a").each((function(){$(this).attr("target","_blank"),-1===$(this).attr("href").indexOf(e.get_page_url())&&$(this).attr("href",e.get_page_url()+$(this).attr("href"))})),$(t).removeClass("hidden").appendTo("#inbox .conversation-container"),s.get_storage({inbox_notification:e.get_defaults("inbox_notification")},(function(t){if(t.inbox_notification&&r){let t=$(t).attr("href").split("/"),a=t[2].split(".").pop(),i=[];i["Laneros.Conversations."+a]={notification_url:e.get_page_url()+$(t).attr("href").substr(1)},s.send_notification("Laneros.Conversations."+a,{type:"basic",title:s.get_message("label_new_messages"),message:$(t).text(),iconUrl:$(o).attr("src")},!0),s.add_notification_listener(i)}}))})),0===$(a).find("div.menu-row").length&&r||i.find(".alert-inbox-message").removeClass("hidden")};$.getJSON(e.get_page_url()+"conversations/popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,a),i.find(".conversation-item:gt(0)").remove(),i.find(".alert-inbox-message").addClass("hidden"),$(".alert-no-sections").addClass("hidden"),$(".inbox-tab-nav a").removeClass("hidden")}else $("#inbox .alert-inbox-message").removeClass("hidden")}))}get_alerts(){let e=new i,t=this;s.get_storage({show_alerts:e.get_defaults("show_alerts")},(function(a){let i=$("#alerts");if(a.show_alerts){let a=function(t){let a=document.createElement("div"),r=!1;$(a).html(t.html.content),i.find(".alert-item:gt(0)").remove(),i.find(".loading-data").hide(),0===$(a).find("div.menu-row").length&&$(a).find("li.menu-row--separated").each((function(){let t=$("#alerts").find(".alert-item:first").clone(),a=$(this).find(".contentRow-main"),i=$(this).find(".contentRow-figure"),n=$(i).find("a.avatar img"),o=$(a).find(".contentRow-minor--smaller time"),l=$(this).hasClass("new");$(a).find(".reaction").data("reaction-id"),l&&(r=!0,$(t).addClass("bg-yellow-100"),$(t).find(".alert-content").addClass("text-gray-600 hover:text-gray-900")),1===$(n).length?$(t).find(".alert-avatar > img").attr("src",$(n).attr("src")).attr("alt",$(n).attr("alt")):$(t).find(".alert-avatar > img").addClass("bg-gray-600 border border-gray-900"),$(a).find(".contentRow-minor--smaller, i").remove(),$(t).find(".alert-avatar").attr("href",$(i).find("a.avatar").attr("href")),$(t).find(".alert-content").html($(a).html()),$(t).find(".alert-time").html($(o).html()).attr("title",$(o).attr("title")),$(t).find(".alert-content img").removeClass().addClass("inline-block"),$(t).find("a").removeClass().addClass("text-blue-500 hover:text-blue-600"),$(t).find("bdi").removeClass().addClass("font-bold"),$(t).find("a").each((function(){$(this).attr("target","_blank"),-1===$(this).attr("href").indexOf(e.get_page_url())&&$(this).attr("href",e.get_page_url()+$(this).attr("href"))})),$(t).removeClass("hidden").appendTo("#alerts .alert-container"),s.get_storage({alerts_notification:e.get_page_url("alerts_notification")},(function(t){if(t.alerts_notification&&r){let t=Math.floor(100*Math.random()+1),i=[];i["Laneros.Alerts."+t]={notification_url:e.get_page_url()+"account/alerts"},s.send_notification("Laneros.Alerts."+t,{type:"basic",title:s.get_message("label_new_alerts"),message:$(a).text(),iconUrl:$(n).attr("src")},!0),s.add_notification_listener(i)}}))})),0===$(a).find("div.menu-row").length&&r||i.find(".alert-alerts-message").removeClass("hidden")};$.getJSON(e.get_page_url()+"account/alerts-popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,a),i.find(".alert-item:gt(0)").remove(),i.find(".alert-alerts-message").addClass("hidden"),$(".alert-no-sections").addClass("hidden"),$(".alerts-tab-nav a").removeClass("hidden")}else $("#alerts .alert-alerts-message").removeClass("hidden")}))}get_subscriptions(){let e=new i,t=this;s.get_storage({show_subscriptions:e.get_defaults("show_subscriptions")},(function(a){let i=$("#subscriptions");if(a.show_subscriptions){let a=function(t){let a=document.createElement("div"),r=!1;$(a).html(t.html.content),i.find(".thread-item:gt(0)").remove(),i.find(".loading-data").hide(),$(a).find(".structItem--thread").length>0?$(a).find(".structItem--thread").each((function(){let t=$("#subscriptions").find(".thread-item:first").clone(),a=document.createElement("a"),i=document.createElement("a"),n=document.createElement("a"),o=$(this).find(".structItem-cell--main .structItem-title a"),l=$(this).find(".structItem-cell--icon"),d=$(l).find("a.avatar img"),h=$(t).find(".thread-starter"),m=$(this).find(".structItem-cell--main .structItem-parts"),f=$(m).find("li:first a.username"),c=$(m).find("li:eq(1) a"),g=$(m).find("li:last a"),u=$(f).text(),b=$(f).data("user-id"),_=$(this).find(".structItem-cell--latest"),v=$(this).hasClass("is-unread");v&&(r=!0,$(t).addClass("bg-yellow-100"),$(t).find(".thread-body h6 a").addClass("text-gray-600 hover:text-gray-900")),$(this).find(".structItem-secondaryIcon").length>0&&$(t).addClass("border-l-4 border-blue-500"),$(d).length>=1?$(t).find(".thread-avatar > img").attr("src",$(d).attr("src")).attr("alt",$(d).attr("alt")):$(t).find(".thread-avatar > img").addClass("bg-gray-600 border border-gray-900"),$(t).find(".thread-avatar").attr("href",$(l).find("a.avatar").attr("href")),$(t).find(".thread-title").html(o.html()).attr("href",o.attr("href")),$(a).html(u).attr("href","members/"+u+"."+b),$(a).appendTo(h),$(h).append(" · "),$(i).html(c.html()).attr("href",c.attr("href")),$(i).appendTo(h),$(h).append(" · "),$(n).html(g.html()).attr("href",g.attr("href")),$(n).appendTo(h),$(t).find(".message-info .message-by").replaceWith($(_).find(".structItem-minor a")),$(t).find(".message-info .message-at").replaceWith($(_).find("a:first")),$(t).find(".thread-starter a, .message-info a").removeClass().addClass("text-blue-500 hover:text-blue-600"),$(t).find("time").closest("a").removeClass().addClass("text-orange-500 hover:text-orange-600"),$(t).find("a").each((function(){$(this).attr("target","_blank"),-1===$(this).attr("href").indexOf(e.get_page_url())&&$(this).attr("href",e.get_page_url()+$(this).attr("href"))})),$(t).removeClass("hidden").appendTo("#subscriptions .thread-container"),s.get_storage({subscriptions_notification:e.get_defaults("subscriptions_notification")},(function(t){if(t.subscriptions_notification&&v){let t=$(t).attr("href").split("/"),a=t[2].split(".").pop(),i=[];i["Laneros.Subscriptions."+a]={notification_url:e.get_page_url()+$(t).attr("href").substr(1)},s.send_notification("Laneros.Subscriptions."+a,{type:"basic",title:s.get_message("label_new_subscription"),message:$(t).text(),iconUrl:$(d).attr("src")},!0),s.add_notification_listener(i)}}))})):i.find(".alert-subscriptions-message").removeClass("hidden")};$.getJSON(e.get_page_url()+"watched/threads?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,a),i.find(".thread-item:gt(0)").remove(),i.find(".alert-inbox-message").addClass("hidden"),$(".alert-no-sections").addClass("hidden"),$(".subscriptions-tab-nav a").removeClass("hidden")}else $("#subscriptions .alert-subscriptions-message").removeClass("hidden")}))}get_bookmarks(){let e=new i,t=this;s.get_storage({show_bookmarks:e.get_defaults("show_bookmarks")},(function(a){let s=$("#bookmarks");if(a.show_bookmarks){let a=function(t){let a=document.createElement("div");$(a).html(t.html.content),s.find(".bookmark-item:gt(0)").remove(),s.find(".loading-data").hide(),$(a).find(".contentRow-main").length>0&&$(a).find("li.menu-row--separated").each((function(){let t=$("#bookmarks").find(".bookmark-item:first").clone(),a=$(this).find(".contentRow-main .contentRow-title"),s=$(this).find(".contentRow-figure"),i=$(s).find(".avatar img"),r=$(this).find(".contentRow-main .contentRow-snippet"),n=$(this).find(".contentRow-main .contentRow-minor--smaller"),o=$(n).find("time"),l=$(n).find(".tagList"),d=$(i).attr("alt")+"."+$(s).find(".avatar").data("user-id");1===$(i).length?$(t).find(".bookmark-avatar > img").attr("src",$(i).attr("src")).attr("alt",$(i).attr("alt")):$(t).find(".bookmark-avatar > img").addClass("bg-gray-600 border border-gray-900"),$(l).find(".u-srOnly").remove(),$(t).find(".bookmark-avatar").attr("href",e.get_page_url()+"members/"+d),$(t).find(".bookmark-title").html(a.html()).attr("href",a.attr("href")),$(t).find(".bookmark-message").html($(r).html()),$(t).find(".bookmark-author").attr("href",e.get_page_url()+"members/"+d).html($(i).attr("alt")),$(t).find(".bookmark-time").html(o),$(l).find("a").length>0&&($(t).find(".bookmark-labels").removeClass("hidden"),$(l).find("a").each((function(){let e=$(t).find(".bookmark-labels .bookmark-label:first").clone();$(e).html(this).removeClass("hidden").appendTo($(t).find(".bookmark-labels"))}))),$(t).find("a").each((function(){$(this).attr("target","_blank"),-1===$(this).attr("href").indexOf(e.get_page_url())&&$(this).attr("href",e.get_page_url()+$(this).attr("href"))})),$(t).removeClass("hidden").appendTo("#bookmarks .bookmark-container")})),0===$(a).find(".contentRow-main").length&&$("#bookmarks").find(".alert-bookmarks-message").removeClass("hidden")};$.getJSON(e.get_page_url()+"account/bookmarks-popup?_xfResponseType=json&_xfNoRedirect=1&_xfToken="+t.user_data.token,a),s.find(".bookmark-item:gt(0)").remove(),s.find(".alert-bookmarks-message").addClass("hidden"),$(".alert-no-sections").addClass("hidden"),$(".bookmarks-tab-nav a").removeClass("hidden")}else $("#bookmarks .alert-bookmarks-message").removeClass("hidden")}))}}